<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no">
  <title>FIND</title>
  <style>
  </style>
  <script defer="defer" src="/test-game/bundle.js"></script>
</head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Lexend:wght@100..900&family=Oleo+Script:wght@400;700&display=swap" rel="stylesheet">
<script src="/test-game/module-data.js"></script>
<script>
  // åˆ¤æ–­æ˜¯å¦ä¸ºå¼€å‘ç¯å¢ƒ
  const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  if (isDev) {
    // å¼€å‘ç¯å¢ƒä½¿ç”¨ mock æ–‡ä»¶
    document.write('<script src="/test-game/js/mock/fbinstant.7.1.mock.js"><\/script>');
  } else {
    // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå® FB SDK
    document.write('<script src="https://connect.facebook.net/en_US/fbinstant.8.0.js"><\/script>');
  }
</script>
<body>
  <div id="root"></div>
  <script>
    window.console.log = (a) => {}
    
    // ğŸ”¥ é¦–å…ˆè®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆåœ¨æœ€å‰é¢ï¼‰
    console.log('ğŸ¯ å¼€å§‹è®¾ç½® postMessage ç›‘å¬å™¨');
    window.addEventListener('message', function(event) {
      console.log('ğŸ“¬ æ”¶åˆ°æ¶ˆæ¯:', event.data);
      if (event.data.type === 'UPDATE_MODULE_DATA') {
        console.log('ğŸ“¨ æ”¶åˆ°æ–°çš„ module data');
        
        // ä¿å­˜åˆ° sessionStorage
        sessionStorage.setItem('customModuleData', JSON.stringify(event.data.data.module_data));
        console.log('ğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ° sessionStorage');
        
        // é€šçŸ¥çˆ¶çª—å£æ•°æ®å·²ä¿å­˜ï¼Œè®©çˆ¶çª—å£é‡æ–°åŠ è½½ iframe
        window.parent.postMessage({ type: 'DATA_SAVED' }, '*');
      }
    });
    console.log('âœ… postMessage ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
    
    // ä¼˜å…ˆä½¿ç”¨ sessionStorage ä¸­çš„æ•°æ®
    const customData = sessionStorage.getItem('customModuleData');
    if (customData) {
      console.log('ğŸ¯ ä½¿ç”¨è‡ªå®šä¹‰ä¸Šä¼ çš„æ•°æ®');
      window.moduleData = JSON.parse(customData);
    } else {
      console.log('ğŸ“¦ ä½¿ç”¨é»˜è®¤ module-data.js æ•°æ®');
      console.log('window.moduleData', moduleData);
      window.moduleData = window.moduleData.module_data;
    }
    window.global ||= window
    window._onProgress = true
    window._isFBInstantInited = false

    window.FBInstantPromise = FBInstant.initializeAsync()
    window.onFBInstantInited = () => window.FBInstantPromise

    window.onFBGameStarted = () => console.log('1020::: onFBGameStarted è¿˜æœªèµ‹å€¼')

    // progressPromise

    async function updateProgress() {
      let progress = 0
      while (progress < 100) {
        if (window._onProgress === false) {
          console.log('updateProgress4', progress)
          progress = 100
          FBInstant.setLoadingProgress(progress)
        } else {
          console.log('updateProgress5', progress)
          progress += Math.floor(Math.random() * 3) + 5
          FBInstant.setLoadingProgress(Math.min(progress, 100))
          await new Promise((res) => setTimeout(res, 500))
        }
      }
      FBInstant.setLoadingProgress(Math.min(progress, 100))
      console.log('1020::: onFBGameStarted 11 ')
      window.FBGameStartedPromise = FBInstant.startGameAsync()
      window.onFBGameStarted = () => window.FBGameStartedPromise
      window._isFBInstantInited = true
    }
    window.progressPromise = updateProgress
  </script>
</body>
</html>
